# Generated by Django 6.0 on 2025-12-21 10:21

from django.db import migrations, models


def forwards_func(apps, schema_editor):
    Utilisateur = apps.get_model("accounts", "Utilisateur")

    for user in Utilisateur.objects.all():

        # üî• R√àGLE N¬∞1 ‚Äî SuperAdmin absolu
        if user.is_superuser:
            user.role = "SuperAdmin"
            user.module = None
            user.station_id = None
            user.save(update_fields=["role", "module", "station"])
            continue

        # üîÅ S√©curit√© legacy : ChefStation ‚Üí Gerant
        if user.role == "ChefStation":
            user.role = "Gerant"

        # üîë Attribution stricte du module
        if (
            user.role in [
                "Gerant",
                "Superviseur",
                "Pompiste",
                "Caissier",
                "PersonnelEntretien",
                "Securite",
                "Collecteur",
            ]
            or user.station_id is not None
        ):
            user.module = "station"
        else:
            # AdminTenant, Tresorier, Lecteur
            user.module = "finance"

        user.save(update_fields=["role", "module"])


class Migration(migrations.Migration):

    dependencies = [
        ('accounts', '0002_utilisateur_station_alter_utilisateur_role'),
        ('stations', '0002_remove_ventecarburant_montant_total_and_more'),
    ]

    operations = [
        # ‚úÖ AJOUT DU CHAMP module
        migrations.AddField(
            model_name='utilisateur',
            name='module',
            field=models.CharField(
                blank=True,
                choices=[('finance', 'Finance'), ('station', 'Station')],
                max_length=20,
                null=True
            ),
        ),

        # ‚úÖ AJOUT DE LA RELATION multi-stations
        migrations.AddField(
            model_name='utilisateur',
            name='stations_administrees',
            field=models.ManyToManyField(
                blank=True,
                related_name='admins',
                to='stations.station'
            ),
        ),

        # ‚úÖ MISE √Ä JOUR DES R√îLES
        migrations.AlterField(
            model_name='utilisateur',
            name='role',
            field=models.CharField(
                choices=[
                    ('SuperAdmin', 'SuperAdmin'),
                    ('AdminTenant', 'Administrateur'),
                    ('Tresorier', 'Tr√©sorier'),
                    ('Gerant', 'Chef de station'),
                    ('Superviseur', 'Chef de piste'),
                    ('Pompiste', 'Agent de distribution'),
                    ('Caissier', 'Vendeur boutique'),
                    ('PersonnelEntretien', 'Nettoyage'),
                    ('Securite', 'Pr√©vention des risques'),
                    ('Collecteur', 'Collecteur'),
                    ('Lecteur', 'Lecteur'),
                ],
                default='Lecteur',
                max_length=30
            ),
        ),

        # ‚úÖ MIGRATION DES DONN√âES EXISTANTES
        migrations.RunPython(forwards_func),
    ]
